---
layout: post
title: "CostOptimizetion"
date: 2023-08-27
category: AWS
excerpt: ""
---
# コスト最適化
## 早引き
- リザーブドインスタンス：1年または3年の契約を結んでオンデマンドインスタンスより安価になる購入オプション
  - EC2インスタンスのみが対象
- Compute Savings Plan：1年もしくは3年の期間、一定のサービス使用量（1時間あたりの利用料金）を決めて契約することで、オンデマンド料金よりも安価になる購入オプション
  - EC2、AWS Lambda、AWS Fargateが対象
- リクエスタ支払い：アクセス元が支払うようになるのでコスト削減につながる
- RDS
  - RDSは起動時間で課金される
  - RDSインスタンスに自動で停止・起動するオプションはない
  - 利用しない時間は停止したい時は、EventBridgeでスケジュールを作成し、ターゲットにRDSの停止・実行をするLambda関数を指定することで実現できる
- AWS Storage Gatewayには最大料金（125USD/ゲートウェイ）が設定されている
- Direct ConnectはAWSとオンプレミスとを**継続して**接続する場合に最適
- スポットインスタンスを利用していても、SQSキューを利用してリクエストを中継していれば、インスタンスが突然中断された場合でもデータが消失せずに、別のEC2インスタンスで継続してアプリケーションを実行できる
- S3 Glacier Flexible Retrivalの最低保持期間は９０日
- DynamoDBはオンデマンドにすることで、負荷に応じて自動でスケーリングしてくれる。Auto Scalingは不要。
- CloudFrontでのデータ転送量を抑えるためには、エッジロケーションによるファイル圧縮処理(gzip)を実施することで実現できる
- コンパーティブル：変更が自由にできる -> コスト高め


## Amazon EventBridge（CloudWatch Events）
- AWS上のリソースの状態変化やスケジュールに応じてアクションを実行することができるサービス
- イベントルールを定義する際、トリガーとなるものを「イベントソース」と呼び、行う処理のことを「ターゲット」と呼ぶ
- EventBridgeでスケジュールを作成し、ターゲットにLambda関数を指定することで、毎日決まった時間にLambda関数を実行できる


## EC2インスタンスの購入オプション
### インスタンスを他のAWSアカウントと共用するもの
- オンデマンドインスタンス：
  - インスタンスの起動時間に基づいた料金体系で、EC2インスタンスのデフォルトの購入オプション
  - 開発環境など、利用が短期間のシステムに適している
- リザーブドインスタンス：
  - 1年もしくは3年の長期契約を結ぶことによって、オンデマンドインスタンスよりも低価格で利用できる購入オプション
  - 1年以上にわたり継続して稼働するシステムに適している
  - リザーブドインスタンスは、1年契約より3年契約、前払い無しより前払い有りの方が割引率が高い
- スポットインスタンス
  - AWS内で使用されていないEC2インスタンスを低価格で利用できる購入オプション
  - EC2インスタンスの購入オプションの中で、**もっとも割引率が高い**
  - スポットインスタンスの価格は、AZ内の各インスタンスタイプの需要と供給バランスに基づいて決定される
  - インスタンスの需要が急増するか供給が不足する場合、インスタンスが中断されるリスクがある
  - インスタンスの中断が許容されるシステム（例：並列バッチ処理の一部のインスタンスなど）に向いている

### AWSアカウント内でハードウェアを専有するもの
- ハードウェア専有インスタンス：
  - 他のAWSアカウントとは分離された専用ハードウェアでEC2インスタンスを利用できる購入オプション
  - 物理的なCPUソケット、コア数、ホストIDは確認できない
  - ハードウェア専有インスタンスは、同AWSアカウントのハードウェア専有インスタンスではないインスタンスと、ハードウェアを共有する可能性がある

- 専有ホスト（Dedicated Hosts）：
  - 他のEC2インスタンスとは分離された専用ハードウェアで利用できる購入オプション
  - 物理的なCPUソケット、コア数、ホストIDを確認できる
  - Dedicated Hosts（専有ホスト）のハードウェアには、ユーザーが指定したインスタンスのみ配置される
  - 利用例)CPUソケットや物理コア、仮想マシンごとに割り当てられたソフトウェアライセンスを保有している場合
  - Dedicated Hosts（専有ホスト）はEC2インスタンスを利用する上で、もっとも購入価格が高いオプションです
 
## データ転送のコスト比較表

| 項目 | サービス利用料金 | データ転送料金 | 備考 |
| --- | --- | --- | --- |
| 同一AZ内 | -  | 無料 |  |
| 同ーリージョン内 | - | 0.01 USD/GB | ・インバウンド通信は無料 |
| リージョン間 | - | 0.09USD/GB |  |
| インターネットからAWS（インバウンド通信） | - | 無料 | ・ELB、Global Acceleratorなどを利用する場合は、別途利用料が必要 |
| AWSからインターネット（アウトバウンド通信） | - | 0.114USD/GB（最初の10TB/月まで） | • 100GB/月まで無料<br>• インターネットゲートウェイの利用料は無料 |
| NATゲートウェイ | 0.062USD/時間 | 0.062USD/GB |  |
| CloudFront | 10.009USD/1万リクエスト（HTTP通信） | 0.114USD/GB（最初の10TB/月まで） | • 1TB/月まで無料<br>• オリジンサーバーからCloudFrontへの転送は無料 |
| VPCピアリング | 無料 | 0.01USD/GB | • 双方のVPCに料金が発生<br>• 同一AZ内は無料 |
| Direct Connect | （契約によって異なる） | 0.041USD/GB | ・インバウンド通信は無料 |
| Snowball | 30USD/日✕デバイス数 | 無料 | ・Snowball Edge Storage Optimizedの料金 |
| Storage Gateway | 無料 | 0.01USD/GB | ・オンプレミスからAWSストレージへの転送料金 |
| DataSync | 無料 | 0.0125USD/GB | ・オンプレミスからAWSストレージへの転送料金 |

## AWS Resource Access Manager（RAM）
- AWSリソースを複数のAWSアカウントで共有できるサービス
- 共有可能なAWSリソースには、Amazon EC2、AWS VPC、Amazon Transit Gatewayなど
- Resouce Access Managerを利用してVPCを共有することにより、他アカウントからプライベートネットワーク経由で自アカウントのVPCへアクセスできるようになる
