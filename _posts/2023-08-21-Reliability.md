---
layout: post
title: "Reliability"
date: 2023-08-21
category: AWS
excerpt: ""
---
# 信頼性のテスト振り返り
## 早引き
- **ストリーミングデータ**を**リアルタイム**で収集する -> Amazon Kinesis
- リクエスト発生時のみ処理を発生させたい -> Lambda
- スケーリングされるインスタンスでは、セッション情報をデータベースに保存してインスタンス間で共有するのがベストプラクティス
  - インスタンスがスケールイン(減らされる)時にセッション情報が消えてしまうため 
- 疎結合 -> SQS, Amazon API Gateway
- RTO（Recovery Point Objective：目標復旧時点）：障害が発生した時点からどれまで前に遡るのを許容できるか
- RTO（Recovery Time Objective：目標復旧時間)：障害が発生してからどれくらいで復旧できるか
- スナップショットは他リージョンにリードレプリカを作るよりも安価

  
## Amazon Kinesis
- ストリーミングデータ(継続的に生成されるデータ)をリアルタイムで収集・処理するサービス
  - 例)スマートフォンアプリなどでユーザーが生成するログや、証券取引所の株取引情報、SNSやオンラインゲームのデータなど
  - ストリーム処理　 ⇄ バッチ処理
- サンプリングや分析などの処理を通して、リアルタイムなトレンド情報をユーザーへフィードバックしたり、企業の経営戦略などに繋げることができる
- Kinesisではストリーミングデータを生成し送信するデバイスやサービスなどを「プロデューサー」、ストリーミングデータを読みだして処理する側を「コンシューマー」と呼ぶ

![k58587](https://github.com/IzmYuta/TIL/assets/104307371/0ac7c006-18a5-40a9-a6f0-d11d75dd70b3)

**Kinesis Data Streams**
- 外部から送信されるストリーミングデータを収集
- ストリーム上のデータは分析や機械学習などを行うアプリケーション(AWS Lambdaなど)がリアルタイムに読みだして処理
- ストリーミングデータを「データレコード」という単位で処理する
- データレコードには、データそのものに加えて「パーティションキー」「シーケンス番号」が含まれる
  - パーティションキー： どのシャード（後述）で処理するかを決めるもの。プロデューサー側で設定する
  - シーケンス番号： シャードごとに一意の番号。シャード内のデータレコードの順序性が保証される

![k58778](https://github.com/IzmYuta/TIL/assets/104307371/87bd3c6e-52ea-483f-9eef-1009fb2bddff)

**Kinesis Data Firehose**
- ストリーミングデータをAmazon S3（ストレージ）、Amazon Redshift（データベース）、Amazon OpenSearch Service（データ分析）などのサービスへ配信するサービス
  -ストリーミングデータは事前に設定されたデータ配信先へ配信される。中継するアプリケーションを独自に実装する必要はない。 

![kk58587](https://github.com/IzmYuta/TIL/assets/104307371/41732287-92d8-4714-8c6f-ad9833393a34)

**Kinesis Data Analytics**
- Kinesis上のストリーミングデータを処理し、可視化・分析できるサービス
  - 処理用のテンプレートが用
意されていたり、標準SQLのクエリが発行できたり、JavaやPythonなどのプログラミング言語がサポートされているなど、柔軟に処理を組み込むことができる
  - データをデータベースへ移行することなく処理することで、リアルタイムに結果を得ることができる

![kkk58587](https://github.com/IzmYuta/TIL/assets/104307371/1a67db9c-490e-4090-8824-d9e6dbeebd64)

**Kinesis Video Streams**
- カメラやビデオなどの動画（ビデオストリーム）を取り込むサービス。取り込んだ動画データはアプリケーションなどによって解析や加工、再生などを行うことができる。

![kkkk58587](https://github.com/IzmYuta/TIL/assets/104307371/0d243ced-18c3-4400-a88e-81ef28cd9296)


## AWS Lambda
- サーバーレスでプログラムのコードを実行できるサービス
  - サーバーレス：リクエスト発生時にだけプログラムが実行されるアーキテクチャ


## Amazon SQS
- フルマネージドのメッセージキューイングサービス
- プル型のメッセージキューイングシステム
  - 受信者の都合の良いタイミングでSQSへポーリング(問い合わせ)してメッセージを受け取る
- サービス同士の橋渡しを担う
- ロングポーリングにすることで、APIコールがない時のコストを削減することができる

## AWS Glue
- データ分析向けのETLサービス
- ETL…データのExtract（抽出）・Transform（変換）・Load（書き出し）

# Amazon Elasticache
- フルマネージド型のインメモリデータベースサービス
  - データベースの拡張や障害の検出・復旧、バックアップなどはAWSによって管理
  - インメモリデータベースはデータストレージにメモリを使用するDBのこと
  - HDDよりも高速・安定したアクセスが可能

![k58350](https://github.com/IzmYuta/TIL/assets/104307371/48b3f0d3-803b-4ce2-bda4-dd9388ba3ff6)

- RDSやRedshiftなど他のデータベースサービスと連携し、クエリの結果をElastiCacheにキャッシュさせることで全体的なパフォーマンスを向上させる、というような使い方ができる
- ElasticacheはKVS（Key-Value Store）型のデータベースエンジンが2つ用意されており、データベースを構築する際に選択することができる
  - データベースエンジンはMemcached、Redisから選択可能

**Memcached**
- 高パフォーマンスを提供する
- データの永続保持やバックアップ機能はないため、シンプルなキャッシュとして利用する

**Redis**
- 高パフォーマンス＋高可用性、機密性を提供する
- 耐障害性の機能として「自動フェイルオーバー(障害発生時に自動切り替え)」「マルチAZ」がある
  - フェイルオーバー：プライマリノードに障害が発生した場合は自動的にレプリカノードがプライマリノードへ昇格

![kkk58407](https://github.com/IzmYuta/TIL/assets/104307371/caf4016c-1cd3-4047-9cad-cdbd57ba37da)

## Route53
- DNS名前解決サービス

**フェイルオーバールーティングポリシー**
- 通常時はプライマリに設定したリソースのIPアドレスを回答、プライマリのリソースにヘルスチェックで異常が発生した場合は、セカンダリに設定したリソースのIPアドレスを回答
- フェイルオーバールーティングポリシーをマルチリージョンで設定することで、災害時には自動的にセカンダリリージョンに切り替えられる

## Amazon SNS
- プッシュ型のメッセージングサービス
  - サブスクライバーの状況によらずメッセージの配信が行われる
- システムの状態に変化があった際のシステム管理者への通知や不特定多数のユーザーへの定期的なメッセージ配信などができる
  - EメールやSMS、Amazon SQSを通してユーザーやアプリケーションに対して通知
- 情報の単位は「トピック」で管理される
  - 標準とFIFO(First In First Out)の2種類がある


**標準**
- 処理するメッセージの順序性が保証されない
- メッセージの重複排除も搭載されていない
- メッセージの配信が「少なくとも1回」される

**FIFO**
- メッセージが順序付けられてAmazon SQSのFIFOキューへ配信される
- SQS以外のプロトコルでは利用できない
- メッセージの配信が「必ず1回だけ」される
- イベントが発生した順番通りに処理したい場合や、処理が重複してはいけないようなケースで利用
