---
layout: post
title: "security"
date: 2023-08-23
category: AWS
excerpt: ""
---
# セキュリティ
## 早引き
- 認証を安全に行う方法
  - KMSで暗号化した認証情報を埋め込む
  - Secrets Managerによるシークレット情報の管理
  - Systems Managerのパラメータストアによる認証情報の一元管理
 - KMSは認証のための暗号化キーを生成するサービス。認証情報は管理しない。
 - Secrets Managerは認証情報を管理するサービス
 - 監査を行うサービス：
   - AWS Config：AWSリソースの設定を監視する
   - Cloud Trail：ユーザーの操作を監視
   - Cloud Watch：AWSリソースのメモリなどを定期的に監視する(セキュリティ用ではない)
   - (例)AWS Configで**違反項目を検出**した後、CloudTrailにより**誰が**対象のリソースを変更したのかを調べる

## AWS Site-to-Site VPN(サイト間VPN)
- カスタマーゲートウェイ（オンプレミスのルーター）とVPCの仮想プライベートゲートウェイ（VGW）を、インターネットVPNで接続するサービス
- インターネット上に仮想の専用線であるVPNトンネルを張り、IPsecという暗号技術を使って通信を保護する

## Lambda関数
- lambda関数は、Lambda専用のセキュアなVPCに配置されている
  - このLambda専用のVPCからは、インターネットや、インターネットを経由してパブリックサブネット内のAWSリソースにはアクセスできる
  - パブリックに公開されていないAWSリソースへはアクセスできない
- Lambda関数からAWS Site-to-Site VPN経由でオンプレミスのデータベースにアクセスするには、Lambda関数をVGWが接続されているVPCに関連付ける「VPCアクセス」の設定が必要
  - VPCアクセスを設定すると、Lambda関数に関連付けたVPCのサブネットに接続用のENI（Elastic Network Interface）を作成してサブネットへアクセスできるようになる
  - VPCアクセスを設定したLambda関数は、ENIを作成したサブネットへアクセスできるようになる代わりに、インターネットへアクセスできなくなる
- サーバーやデータベースへアクセスする際、認証が必要になるケースがあります
  - このとき、ユーザーIDやパスワードなどの認証情報はソースコードに埋め込む（ハードコーディング）するべきではない
  - ではどうする？ -> KMSを利用する
    - Lambda関数にKMSで暗号化した認証情報を埋め込む
    - 関数呼び出し時に、認証情報を復号する

## AWSのリソース保護
### AWS WAF
- 脆弱性を突く攻撃（クロスサイトスクリプティングやSQLインジェクションなど）から、**Webアプリケーションを保護**するサービス
- Web ACL」というアクセスコントロールリストで、IPアドレス、HTTPヘッダー、HTTP本文、URI文字列などに対してフィルタリングの条件を設定できる
- 接続元のIPアドレスから国別にアクセスを制限できる機能がある
- Amazon CloudFront、Application Load Balancer、Amazon API Gatewayなどに割り当てて利用可能
- NLBはサポートしていない
- S3を直接保護することはできない。CloudFrontを経由する必要がある。

### AWS Shield
- **DDoS攻撃からの保護に特化**したサービス
- **ネットワークを保護する**
- API Gatewayはサポートしていない
- すべてのAWSユーザーが無償で利用できる「AWS Shield Standard」と、有償版の「AWS Shield Advanced」がある

**AWS Shield Standard**
- ネットワーク層およびトランスポート層への一般的なDDoS攻撃からAWSリソースを保護
- デフォルトで有効

**AWS Shield Advanced**
- EC2インスタンス、Elastic Load Balancing、Amazon CloudFrontなどを標的としたDDoS攻撃に対して、高度な保護サービスが利用可能
  - 高度化された大規模な攻撃からの保護
  - DDoS攻撃発生時のモニタリングやレポート
  - AWSのDDoS対応チームによるサポート
  - 攻撃によって増加したAWS利用料金の補填
  - etc...
  
## 暗号化
- データの暗号化・復号はサーバーまたはクライアントのいずれかで行われる
  - サーバー側の暗号化（Server-Side Encryption:SSE）は、AWS（サービス提供側＝サーバー側）にデータが保存されるタイミングで暗号化が行われる
  - ユーザーがデータを取り出す際もサーバー側が復号して渡す
  - クライアント側の暗号化は、サーバーへデータを送信する前にクライアント側で暗号化を行う
  - サーバー側では受け取ったデータをそのまま保存します。また、データの復号もクライアント側で行う
- AWS側で暗号化が行われる場合はほとんどがサーバー側の暗号化
- クライアント側の暗号化は、通信回線のセキュリティに不安があるなどユーザーが自主的に暗号化したいケースで使用される
  - クライアント側の暗号化は、暗号化および復号をユーザー側で行うため、鍵の利用状況のチェックや監査などもユーザー自身が行う必要がある
  - クライアント側の暗号化を行うにはAWS SDKを使用する

### AWS KMS(Key Management Service)
- 暗号化に使用する鍵（キー）を作成・管理するサービス
- エンベロープ暗号化方式を使っている
  - 2段階で鍵を保護する方式のこと
  - KMSでは、「KMSキー」「データキー」と呼ばれる2種類の鍵を使用してデータの暗号化および復号を行なっている
  - 「KMSキー」はデータキーを暗号化する際に使用し、「データキー」はデータを暗号化するために使う
  - データキーは通常、暗号化を行う対象のサービスごとに作成 -> 1つのデータキーが漏出しても他のサービスに影響が出ない
- 通常は、暗号化を行う対象のサービス（Amazon S3やEBS、Redshiftなど）と連携して利用する
- AWS CloudTrailと連携しており、鍵の使用ログ（いつどのサービスで鍵が使用されたか）が記録されるため、鍵の利用状況を監査することができる

**KSMキー**
- KMSキーには「AWSマネージド型」と「カスタマーマネージド型」がある
  - AWSによって作成・管理されるものは「AWSマネージド型」であり、ユーザーは削除できない
  - AWSマネージド型の鍵は、連携したEBSやRedshiftなどのサービスで暗号化を利用したタイミングでAWSが作成する
  - カスタマーマネージド型のKMSキーはユーザーが作成・削除、および管理を行う
  - 作成した鍵を長期間利用するのはセキュリティ上危険なため、KMSでは鍵の自動ローテーション（定期的な更新）をサポートしている

**キーポリシー**
- カスタマーマネージド型のKMSキーへ適用するリソースベースのポリシー
- 鍵に対して、IAMユーザーまたはIAMロール、他のAWSアカウントへの操作可能な権限を設定
- 鍵の作成者とは異なるIAMユーザーやIAMロールが、鍵を使って暗号化や復号をしたい場合、キーユーザーとして使用者を追加できる
- 別のAWSアカウントで鍵を使用したい場合は、対象のアカウントと鍵を共有する（クロスアカウント）
- **AWSマネージド型の鍵はキーポリシーを編集できないため他アカウントと共有できない**

### AWS CloudHSM
- 専用のハードウェアデバイスを用いて暗号化鍵を生成・管理するサービス
  - 貸し出されるハードウェアは世界的な暗号化ハードウェアの規格（FIPS 140-2 のレベル 3）で認証済みで、信頼度が高い
- 鍵の生成や保管・削除などのライフサイクル管理はユーザー自身が行う
- 運用面においても、CloudHSMは他のAWSユーザーと分離するためにAmazon VPC内にプロビジョニングする必要があるなど、KMSよりもセキュアな運用が求められる
- 専用のハードウェアを使用する分、KMSと比べると利用料金が高価に設定されている
- AWSクラウド上で暗号化鍵を管理するKMSよりもセキュアな運用が求められるようなケースで利用

## AWS Config
- AWSリソースの設定を管理し、記録・評価するサービス
- AWSリソースの設定がいつ変更されたかを記録し、変更がルールに準拠したものでない場合には「非準拠」として記録

### SNS通知
- Configでは指定したリソースに設定変更があった場合に、SNSから通知を受け取るように設定できる
- ルールに準拠していないリソースがある場合に通知を受け取る場合は、Amazon EventBridgeと連携する。
  - ルールが非準拠になったことをトリガーにしたEventBridgeのイベントルールを作成し、 SNSから通知するよう設定

## ルール
- ルールの作成には、AWSが用意したルールをカスタマイズしたり、Lambda関数を使用した独自ルールを追加したりできる
- 例えば、AWSリソースに対して用途や環境などの管理のためにタグを付与している場合、AWS Configの「required-tags」ルールではタグの付与漏れがないかをチェックできる
- 2022年6月現在では、EC2、ELB、RDS、Redshift、S3などのリソースに対応

## Amazon Cognito
- モバイルアプリケーションやWebアプリケーション向けのユーザー認証機能を提供するサービス
- 新たにユーザー登録を行ったり、外部のIDプロバイダと連携したユーザー認証、およびユーザーの管理も行える
- ユーザー数の上限がデフォルトで2000万と非常に大きいため、不特定多数のユーザーが利用するアプリケーションのユーザー管理に適している

## AWS Trusted Advisor
- 利用者のAWS環境をAWSに蓄積されたベストプラクティスと照会することにより、推奨されるアクションのアドバイスを行うサービス

## S3
- S3のサーバー側の暗号化方式(SSE)には3種類ある
  - SSE-S3：S3が管理している鍵を使用する
  - SSE-KMS：AWS KMS（AWS Key Management Service）に保存されているKMSキーを使用する
  - SSE-C：ユーザーが管理している鍵を使用する
